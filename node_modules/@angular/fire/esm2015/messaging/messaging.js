/**
 * @fileoverview added by tsickle
 * Generated from: messaging.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { Inject, Injectable, InjectionToken, NgZone, Optional, PLATFORM_ID } from '@angular/core';
import firebase from 'firebase/app';
import { concat, EMPTY, Observable, of, throwError } from 'rxjs';
import { catchError, defaultIfEmpty, map, mergeMap, observeOn, switchMap, switchMapTo, shareReplay, subscribeOn } from 'rxjs/operators';
import { FIREBASE_APP_NAME, FIREBASE_OPTIONS, ɵAngularFireSchedulers, ɵfirebaseAppFactory, ɵlazySDKProxy, ɵapplyMixins } from '@angular/fire';
import { isPlatformServer } from '@angular/common';
import { proxyPolyfillCompat } from './base';
import { ɵfetchInstance } from '@angular/fire';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
export const VAPID_KEY = new InjectionToken('angularfire2.messaging.vapid-key');
/** @type {?} */
export const SERVICE_WORKER = new InjectionToken('angularfire2.messaging.service-worker-registeration');
// SEMVER(7): drop
/** @type {?} */
const firebaseLTv8 = parseInt(firebase.SDK_VERSION, 10) < 8;
// WARNING: interface has both a type and a value, skipping emit
export class AngularFireMessaging {
    /**
     * @param {?} options
     * @param {?} nameOrConfig
     * @param {?} platformId
     * @param {?} zone
     * @param {?} vapidKey
     * @param {?} _serviceWorker
     */
    constructor(options, nameOrConfig, 
    // tslint:disable-next-line:ban-types
    platformId, zone, vapidKey, _serviceWorker) {
        /** @type {?} */
        const schedulers = new ɵAngularFireSchedulers(zone);
        /** @type {?} */
        const serviceWorker = _serviceWorker;
        /** @type {?} */
        const messaging = of(undefined).pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @return {?}
         */
        () => isPlatformServer(platformId) ? EMPTY : import('firebase/messaging'))), map((/**
         * @return {?}
         */
        () => ɵfirebaseAppFactory(options, zone, nameOrConfig))), switchMap((/**
         * @param {?} app
         * @return {?}
         */
        app => ɵfetchInstance(`${app.name}.messaging`, 'AngularFireMessaging', app, (/**
         * @return {?}
         */
        () => __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const messaging = app.messaging();
            if (firebaseLTv8) {
                if (vapidKey) {
                    messaging.usePublicVapidKey(vapidKey);
                }
                if (serviceWorker) {
                    messaging.useServiceWorker(yield serviceWorker);
                }
            }
            return messaging;
        })), [vapidKey, serviceWorker]))), shareReplay({ bufferSize: 1, refCount: false }));
        this.requestPermission = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), 
        // tslint:disable-next-line
        switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        messaging => firebase.messaging.isSupported() ? messaging.requestPermission() : throwError('Not supported.'))));
        this.getToken = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        (messaging) => __awaiter(this, void 0, void 0, function* () {
            if (firebase.messaging.isSupported() && Notification.permission === 'granted') {
                if (firebaseLTv8) {
                    return yield messaging.getToken();
                }
                else {
                    /** @type {?} */
                    const serviceWorkerRegistration = serviceWorker ? yield serviceWorker : null;
                    return yield messaging.getToken({ vapidKey, serviceWorkerRegistration });
                }
            }
            else {
                return null;
            }
        }))));
        /** @type {?} */
        const notificationPermission$ = new Observable((/**
         * @param {?} emitter
         * @return {?}
         */
        emitter => {
            navigator.permissions.query({ name: 'notifications' }).then((/**
             * @param {?} notificationPerm
             * @return {?}
             */
            notificationPerm => {
                notificationPerm.onchange = (/**
                 * @return {?}
                 */
                () => emitter.next());
            }));
        }));
        /** @type {?} */
        const tokenChange$ = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMapTo(notificationPermission$), switchMapTo(this.getToken));
        this.tokenChanges = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @return {?}
         */
        () => firebase.messaging.isSupported() ? concat(this.getToken, tokenChange$) : EMPTY)));
        this.messages = messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        messaging => firebase.messaging.isSupported() ? new Observable((/**
         * @param {?} emitter
         * @return {?}
         */
        emitter => messaging.onMessage((/**
         * @param {?} next
         * @return {?}
         */
        next => emitter.next(next)), (/**
         * @param {?} err
         * @return {?}
         */
        err => emitter.error(err)), (/**
         * @return {?}
         */
        () => emitter.complete())))) : EMPTY)));
        this.requestToken = of(undefined).pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @return {?}
         */
        () => this.requestPermission)), catchError((/**
         * @return {?}
         */
        () => of(null))), mergeMap((/**
         * @return {?}
         */
        () => this.tokenChanges)));
        // SEMVER(7): drop token
        this.deleteToken = (/**
         * @param {?=} token
         * @return {?}
         */
        (token) => messaging.pipe(subscribeOn(schedulers.outsideAngular), observeOn(schedulers.insideAngular), switchMap((/**
         * @param {?} messaging
         * @return {?}
         */
        messaging => messaging.deleteToken(token || undefined))), defaultIfEmpty(false)));
        return ɵlazySDKProxy(this, messaging, zone);
    }
}
AngularFireMessaging.ɵfac = function AngularFireMessaging_Factory(t) { return new (t || AngularFireMessaging)(ɵngcc0.ɵɵinject(FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(VAPID_KEY, 8), ɵngcc0.ɵɵinject(SERVICE_WORKER, 8)); };
/** @nocollapse */
AngularFireMessaging.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [FIREBASE_OPTIONS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [FIREBASE_APP_NAME,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [VAPID_KEY,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [SERVICE_WORKER,] }] }
];
/** @nocollapse */ AngularFireMessaging.ɵprov = i0.ɵɵdefineInjectable({ factory: function AngularFireMessaging_Factory() { return new AngularFireMessaging(i0.ɵɵinject(i1.FIREBASE_OPTIONS), i0.ɵɵinject(i1.FIREBASE_APP_NAME, 8), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(VAPID_KEY, 8), i0.ɵɵinject(SERVICE_WORKER, 8)); }, token: AngularFireMessaging, providedIn: "any" });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireMessaging, [{
        type: Injectable,
        args: [{
                providedIn: 'any'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [FIREBASE_OPTIONS]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [FIREBASE_APP_NAME]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: ɵngcc0.NgZone }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [VAPID_KEY]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [SERVICE_WORKER]
            }] }]; }, null); })();
if (false) {
    /** @type {?} */
    AngularFireMessaging.prototype.requestPermission;
    /** @type {?} */
    AngularFireMessaging.prototype.getToken;
    /** @type {?} */
    AngularFireMessaging.prototype.tokenChanges;
    /** @type {?} */
    AngularFireMessaging.prototype.messages;
    /** @type {?} */
    AngularFireMessaging.prototype.requestToken;
    /** @type {?} */
    AngularFireMessaging.prototype.deleteToken;
}
ɵapplyMixins(AngularFireMessaging, [proxyPolyfillCompat]);

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnaW5nLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9ydW5uZXIvd29yay9hbmd1bGFyZmlyZS9hbmd1bGFyZmlyZS9zcmMvbWVzc2FnaW5nL21lc3NhZ2luZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEcsT0FBTyxRQUFRLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFhLE1BQU0sTUFBTSxDQUFDO0FBQzVFLE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFVLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hKLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsZ0JBQWdCLEVBR2hCLHNCQUFzQixFQUN0QixtQkFBbUIsRUFDbkIsYUFBYSxFQUViLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDN0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvQztBQUNvQztBQUFxQzs7QUFBekUsTUFBTSxPQUFPLFNBQVMsR0FBRyxJQUFJLGNBQWMsQ0FBUyxrQ0FBa0MsQ0FBQztBQUN2RjtBQUFBLE1BQU0sT0FBTyxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQXFDLHFEQUFxRCxDQUFDO0FBQzNJO0FBQ2tCO0FBQ0YsTUFBVixZQUFZLEdBQUcsUUFBUSxDQUFD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QVEsWUFBSSxNQUFNLFNBQUMsU0FBUztBQUFTLDRDQUNyQyxRQUFRLFlBQUksTUFBTSxTQUFDLGNBQWM7QUFBUTtBQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7a0NBU3hDO0FBQUM7QUFBYTtBQUFxQixJQXZCMUMsaURBQW9EO0FBQ3REO0FBQXFCLElBQW5CLHdDQUFvRDtBQUN0RDtBQUFxQixJQUFuQiw0Q0FBd0Q7QUFDMUQ7QUFBcUIsSUFBbkIsd0NBQXlDO0FBQzNDO0FBQXFCLElBQW5CLDRDQUF3RDtBQUMxRDtBQUFxQixJQUFuQiwyQ0FBb0U7QUFDdEU7QUEwR0EsWUFBWSxDQUFDLG9CQUFvQixFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0FBQzFEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgTmdab25lLCBPcHRpb25hbCwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCBmaXJlYmFzZSBmcm9tICdmaXJlYmFzZS9hcHAnO1xuaW1wb3J0IHsgY29uY2F0LCBFTVBUWSwgT2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3IsIGZyb21FdmVudCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZGVmYXVsdElmRW1wdHksIG1hcCwgbWVyZ2VNYXAsIG9ic2VydmVPbiwgc3dpdGNoTWFwLCBzd2l0Y2hNYXBUbywgc2hhcmVSZXBsYXksIGZpbHRlciwgc3Vic2NyaWJlT24gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBGSVJFQkFTRV9BUFBfTkFNRSxcbiAgRklSRUJBU0VfT1BUSU9OUyxcbiAgRmlyZWJhc2VBcHBDb25maWcsXG4gIEZpcmViYXNlT3B0aW9ucyxcbiAgybVBbmd1bGFyRmlyZVNjaGVkdWxlcnMsXG4gIMm1ZmlyZWJhc2VBcHBGYWN0b3J5LFxuICDJtWxhenlTREtQcm94eSxcbiAgybVQcm9taXNlUHJveHksXG4gIMm1YXBwbHlNaXhpbnNcbn0gZnJvbSAnQGFuZ3VsYXIvZmlyZSc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IHByb3h5UG9seWZpbGxDb21wYXQgfSBmcm9tICcuL2Jhc2UnO1xuaW1wb3J0IHsgybVmZXRjaEluc3RhbmNlIH0gZnJvbSAnQGFuZ3VsYXIvZmlyZSc7XG5cbmV4cG9ydCBjb25zdCBWQVBJRF9LRVkgPSBuZXcgSW5qZWN0aW9uVG9rZW48c3RyaW5nPignYW5ndWxhcmZpcmUyLm1lc3NhZ2luZy52YXBpZC1rZXknKTtcbmV4cG9ydCBjb25zdCBTRVJWSUNFX1dPUktFUiA9IG5ldyBJbmplY3Rpb25Ub2tlbjxQcm9taXNlPFNlcnZpY2VXb3JrZXJSZWdpc3RyYXRpb24+PignYW5ndWxhcmZpcmUyLm1lc3NhZ2luZy5zZXJ2aWNlLXdvcmtlci1yZWdpc3RlcmF0aW9uJyk7XG5cbi8vIFNFTVZFUig3KTogZHJvcFxuY29uc3QgZmlyZWJhc2VMVHY4ID0gcGFyc2VJbnQoZmlyZWJhc2UuU0RLX1ZFUlNJT04sIDEwKSA8IDg7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQW5ndWxhckZpcmVNZXNzYWdpbmcgZXh0ZW5kcyBPbWl0PMm1UHJvbWlzZVByb3h5PGZpcmViYXNlLm1lc3NhZ2luZy5NZXNzYWdpbmc+LCAnZGVsZXRlVG9rZW4nIHwgJ2dldFRva2VuJyB8ICdyZXF1ZXN0UGVybWlzc2lvbic+IHtcbn1cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAnYW55J1xufSlcbmV4cG9ydCBjbGFzcyBBbmd1bGFyRmlyZU1lc3NhZ2luZyB7XG5cbiAgcHVibGljIHJlYWRvbmx5IHJlcXVlc3RQZXJtaXNzaW9uOiBPYnNlcnZhYmxlPHZvaWQ+O1xuICBwdWJsaWMgcmVhZG9ubHkgZ2V0VG9rZW46IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD47XG4gIHB1YmxpYyByZWFkb25seSB0b2tlbkNoYW5nZXM6IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD47XG4gIHB1YmxpYyByZWFkb25seSBtZXNzYWdlczogT2JzZXJ2YWJsZTx7fT47XG4gIHB1YmxpYyByZWFkb25seSByZXF1ZXN0VG9rZW46IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD47XG4gIHB1YmxpYyByZWFkb25seSBkZWxldGVUb2tlbjogKHRva2VuOiBzdHJpbmcpID0+IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChGSVJFQkFTRV9PUFRJT05TKSBvcHRpb25zOiBGaXJlYmFzZU9wdGlvbnMsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChGSVJFQkFTRV9BUFBfTkFNRSkgbmFtZU9yQ29uZmlnOiBzdHJpbmcgfCBGaXJlYmFzZUFwcENvbmZpZyB8IG51bGwgfCB1bmRlZmluZWQsXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmJhbi10eXBlc1xuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHBsYXRmb3JtSWQ6IE9iamVjdCxcbiAgICB6b25lOiBOZ1pvbmUsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChWQVBJRF9LRVkpIHZhcGlkS2V5OiBzdHJpbmd8bnVsbCxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFNFUlZJQ0VfV09SS0VSKSBfc2VydmljZVdvcmtlcjogYW55LFxuICApIHtcbiAgICBjb25zdCBzY2hlZHVsZXJzID0gbmV3IMm1QW5ndWxhckZpcmVTY2hlZHVsZXJzKHpvbmUpO1xuICAgIGNvbnN0IHNlcnZpY2VXb3JrZXI6IFByb21pc2U8U2VydmljZVdvcmtlclJlZ2lzdHJhdGlvbj4gfCBudWxsID0gX3NlcnZpY2VXb3JrZXI7XG5cbiAgICBjb25zdCBtZXNzYWdpbmcgPSBvZih1bmRlZmluZWQpLnBpcGUoXG4gICAgICBzdWJzY3JpYmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgIG9ic2VydmVPbihzY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpLFxuICAgICAgc3dpdGNoTWFwKCgpID0+IGlzUGxhdGZvcm1TZXJ2ZXIocGxhdGZvcm1JZCkgPyBFTVBUWSA6IGltcG9ydCgnZmlyZWJhc2UvbWVzc2FnaW5nJykpLFxuICAgICAgbWFwKCgpID0+IMm1ZmlyZWJhc2VBcHBGYWN0b3J5KG9wdGlvbnMsIHpvbmUsIG5hbWVPckNvbmZpZykpLFxuICAgICAgc3dpdGNoTWFwKGFwcCA9PiDJtWZldGNoSW5zdGFuY2UoYCR7YXBwLm5hbWV9Lm1lc3NhZ2luZ2AsICdBbmd1bGFyRmlyZU1lc3NhZ2luZycsIGFwcCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdpbmcgPSBhcHAubWVzc2FnaW5nKCk7XG4gICAgICAgIGlmIChmaXJlYmFzZUxUdjgpIHtcbiAgICAgICAgICBpZiAodmFwaWRLZXkpIHtcbiAgICAgICAgICAgIG1lc3NhZ2luZy51c2VQdWJsaWNWYXBpZEtleSh2YXBpZEtleSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzZXJ2aWNlV29ya2VyKSB7XG4gICAgICAgICAgICBtZXNzYWdpbmcudXNlU2VydmljZVdvcmtlcihhd2FpdCBzZXJ2aWNlV29ya2VyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2luZztcbiAgICAgIH0sIFt2YXBpZEtleSwgc2VydmljZVdvcmtlcl0pKSxcbiAgICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IGZhbHNlIH0pXG4gICAgKTtcblxuICAgIHRoaXMucmVxdWVzdFBlcm1pc3Npb24gPSBtZXNzYWdpbmcucGlwZShcbiAgICAgIHN1YnNjcmliZU9uKHNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpLFxuICAgICAgb2JzZXJ2ZU9uKHNjaGVkdWxlcnMuaW5zaWRlQW5ndWxhciksXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICAgIHN3aXRjaE1hcChtZXNzYWdpbmcgPT4gZmlyZWJhc2UubWVzc2FnaW5nLmlzU3VwcG9ydGVkKCkgPyBtZXNzYWdpbmcucmVxdWVzdFBlcm1pc3Npb24oKSA6IHRocm93RXJyb3IoJ05vdCBzdXBwb3J0ZWQuJykpXG4gICAgKTtcblxuICAgIHRoaXMuZ2V0VG9rZW4gPSBtZXNzYWdpbmcucGlwZShcbiAgICAgIHN1YnNjcmliZU9uKHNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpLFxuICAgICAgb2JzZXJ2ZU9uKHNjaGVkdWxlcnMuaW5zaWRlQW5ndWxhciksXG4gICAgICBzd2l0Y2hNYXAoYXN5bmMgbWVzc2FnaW5nID0+IHtcbiAgICAgICAgaWYgKGZpcmViYXNlLm1lc3NhZ2luZy5pc1N1cHBvcnRlZCgpICYmIE5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uID09PSAnZ3JhbnRlZCcpIHtcbiAgICAgICAgICBpZiAoZmlyZWJhc2VMVHY4KSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnaW5nLmdldFRva2VuKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHNlcnZpY2VXb3JrZXJSZWdpc3RyYXRpb24gPSBzZXJ2aWNlV29ya2VyID8gYXdhaXQgc2VydmljZVdvcmtlciA6IG51bGw7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbWVzc2FnaW5nLmdldFRva2VuKHsgdmFwaWRLZXksIHNlcnZpY2VXb3JrZXJSZWdpc3RyYXRpb24gfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBub3RpZmljYXRpb25QZXJtaXNzaW9uJCA9IG5ldyBPYnNlcnZhYmxlPHN0cmluZz4oZW1pdHRlciA9PiB7XG4gICAgICBuYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkoeyBuYW1lOiAnbm90aWZpY2F0aW9ucycgfSkudGhlbihub3RpZmljYXRpb25QZXJtID0+IHtcbiAgICAgICAgbm90aWZpY2F0aW9uUGVybS5vbmNoYW5nZSA9ICgpID0+IGVtaXR0ZXIubmV4dCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCB0b2tlbkNoYW5nZSQgPSBtZXNzYWdpbmcucGlwZShcbiAgICAgIHN1YnNjcmliZU9uKHNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpLFxuICAgICAgb2JzZXJ2ZU9uKHNjaGVkdWxlcnMuaW5zaWRlQW5ndWxhciksXG4gICAgICBzd2l0Y2hNYXBUbyhub3RpZmljYXRpb25QZXJtaXNzaW9uJCksXG4gICAgICBzd2l0Y2hNYXBUbyh0aGlzLmdldFRva2VuKVxuICAgICk7XG5cbiAgICB0aGlzLnRva2VuQ2hhbmdlcyA9IG1lc3NhZ2luZy5waXBlKFxuICAgICAgc3Vic2NyaWJlT24oc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhciksXG4gICAgICBvYnNlcnZlT24oc2NoZWR1bGVycy5pbnNpZGVBbmd1bGFyKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiBmaXJlYmFzZS5tZXNzYWdpbmcuaXNTdXBwb3J0ZWQoKSA/IGNvbmNhdCh0aGlzLmdldFRva2VuLCB0b2tlbkNoYW5nZSQpIDogRU1QVFkpXG4gICAgKTtcblxuXG4gICAgdGhpcy5tZXNzYWdlcyA9IG1lc3NhZ2luZy5waXBlKFxuICAgICAgc3Vic2NyaWJlT24oc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhciksXG4gICAgICBvYnNlcnZlT24oc2NoZWR1bGVycy5pbnNpZGVBbmd1bGFyKSxcbiAgICAgIHN3aXRjaE1hcChtZXNzYWdpbmcgPT4gZmlyZWJhc2UubWVzc2FnaW5nLmlzU3VwcG9ydGVkKCkgPyBuZXcgT2JzZXJ2YWJsZTxzdHJpbmc+KGVtaXR0ZXIgPT5cbiAgICAgICAgbWVzc2FnaW5nLm9uTWVzc2FnZShuZXh0ID0+IGVtaXR0ZXIubmV4dChuZXh0KSwgZXJyID0+IGVtaXR0ZXIuZXJyb3IoZXJyKSwgKCkgPT4gZW1pdHRlci5jb21wbGV0ZSgpKVxuICAgICAgKSA6IEVNUFRZKSxcbiAgICApO1xuXG4gICAgdGhpcy5yZXF1ZXN0VG9rZW4gPSBvZih1bmRlZmluZWQpLnBpcGUoXG4gICAgICBzdWJzY3JpYmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgIG9ic2VydmVPbihzY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpLFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMucmVxdWVzdFBlcm1pc3Npb24pLFxuICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihudWxsKSksXG4gICAgICBtZXJnZU1hcCgoKSA9PiB0aGlzLnRva2VuQ2hhbmdlcylcbiAgICApO1xuXG4gICAgLy8gU0VNVkVSKDcpOiBkcm9wIHRva2VuXG4gICAgdGhpcy5kZWxldGVUb2tlbiA9ICh0b2tlbj86IHN0cmluZykgPT4gbWVzc2FnaW5nLnBpcGUoXG4gICAgICBzdWJzY3JpYmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSxcbiAgICAgIG9ic2VydmVPbihzY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpLFxuICAgICAgc3dpdGNoTWFwKG1lc3NhZ2luZyA9PiBtZXNzYWdpbmcuZGVsZXRlVG9rZW4odG9rZW4gfHwgdW5kZWZpbmVkKSksXG4gICAgICBkZWZhdWx0SWZFbXB0eShmYWxzZSlcbiAgICApO1xuXG4gICAgcmV0dXJuIMm1bGF6eVNES1Byb3h5KHRoaXMsIG1lc3NhZ2luZywgem9uZSk7XG4gIH1cblxufVxuXG7JtWFwcGx5TWl4aW5zKEFuZ3VsYXJGaXJlTWVzc2FnaW5nLCBbcHJveHlQb2x5ZmlsbENvbXBhdF0pO1xuIl19